# Спецификация WebSocket API для Pixel Battle

## Введение

Эта спецификация описывает WebSocket API для игры Pixel Battle, позволяющей пользователям в реальном времени обновлять цвета пикселей на общем канвасе и просматривать текущее состояние поля. API поддерживает аутентификацию пользователей и администраторов, обновление и получение состояния пикселей, административные функции для управления игровым процессом.

## Установление соединения

Для начала взаимодействия с сервером, клиент должен установить WebSocket соединение:

```plaintext
ws://localhost:8000/ws/
```

## Аутентификация

### Базовая логика

1. Клиент подключается к WebSocket-серверу.
2. Клиент отправляет сообщение с `nickname` и опционально с `user_id`.
3. Сервер проверяет наличие `user_id` в сообщении:
   - Если `user_id` отсутствует, сервер создаёт нового пользователя с указанным `nickname` и возвращает клиенту сгенерированный `user_id`.
   - Если `user_id` присутствует, сервер проверяет существующего пользователя с таким `user_id` и сравнивает `nickname`:
     - Если `nickname` отличается от сохранённого в базе, сервер обновляет `nickname` пользователя.
     - Сервер подтверждает клиенту успешное подключение и использование существующего `user_id`.


### Для пользователей

**Запрос:**

```json
{
  "type": "login",
  "data": {
    "nickname": "<псевдоним>",
    "user_id": "<опциональный_идентификатор_пользователя>"
  }
}
```

**Ответ (успех):**

```json
{
  "type": "user_id",
  "data": "<новый_или_существующий_идентификатор_пользователя>"
}
```

**Ответ (ошибка):**

```json
{
  "type": "error",
  "message": "<описание_ошибки>"
}
```

### Для администраторов

**Запрос:**

```json
{
  "type": "login_admin",
  "data": "<токен_администратора>"
}
```

**Ответ (успех):**

Администратор успешно аутентифицирован, может выполнять административные действия.

**Ответ (ошибка):**

```json
{
  "type": "error",
  "message": "Policy Violation"
}
```

## Обновление пикселя

**Запрос:**

```json
{
  "type": "update_pixel",
  "data": {
    "x": <координата_x>,
    "y": <координата_y>,
    "color": "<HEX_цвет>",
    "user_id": "<идентификатор_пользователя>"
  }
}
```

**Ответ пользователям (успех):**

```json
{
  "type": "pixel_update",
  "data": {
    "x": <координата_x>,
    "y": <координата_y>,
    "color": "<HEX_цвет>",
    "nickname": "<псевдоним_пользователя>"
  }
}
```

**Ответ (ошибка):**

```json
{
  "type": "error",
  "message": "You can only color a pixel at a set time."
}
```

## Получение состояния поля

**Запрос:**

```json
{
  "type": "get_field_state"
}
```

**Ответ:**

```json
{
  "type": "field_state",
  "data": [
    {
      "x": <координата_x>,
      "y": <координата_y>,
      "color": "<HEX_цвет>",
      "nickname": "<псевдоним>"
    }
    // Другие пиксели
  ]
}
```

## Административные функции

### Обновление пикселя администратором

**Запрос:**

```json
{
  "type": "update_pixel_admin",
  "data": {
    "x": <координата_x>,
    "y": <координата_y>,
    "color": "<HEX_цвет>"
  }
}
```


**Ответ пользователям (успех):**

```json
{
  "type": "pixel_update",
  "data": {
    "x": <координата_x>,
    "y": <координата_y>,
    "color": "<HEX_цвет>",
    "nickname": "<псевдоним_пользователя>"
  }
}
```

### Получение информации о пикселе

**Запрос:**

```json
{
  "type": "pixel_info_admin",
  "data": {
    "x": <координата_x>,
    "y": <координата_y>
  }
}
```

### Блокировка пользователя

**Запрос:**

```json
{
  "type": "ban_user_admin",
  "data": {
    "user_id": "<идентификатор_пользователя>"
  }
}
```

### Сброс состояния игры

**Запрос:**

```json
{
  "type": "reset_game_admin"
}
```

## Отключение

**Запрос:**

```json
{
  "type": "disconnect"
}
```

Сервер подтверждает отключение и закрывает соединение.

## Обработка ошибок

**Ответ при ошибке:**

```json
{
  "type": "error",
  "message": "<описание_ошибки>"
}
```

В случае возникновения ошибки при обработке запроса, сервер отправляет сообщение об ошибке, указывая тип ошибки и детальное описание проблемы.

---


## Коды ошибок WebSocket

В этой таблице перечислены коды ошибок, используемые в WebSocket соединениях, и их описания:

| Код  | Описание                  | Контекст использования                   |
|------|---------------------------|-----------------------------------------|
| 1000 | Normal Closure            | Используется для обозначения нормального закрытия соединения. |
| 1001 | Going Away                | Соединение закрыто из-за того, что одна из сторон ушла или отключилась. |
| 1002 | Protocol Error            | Используется при обнаружении ошибки в протоколе или неверных данных пользователя. |
| 1003 | Unsupported Data          | Получены данные, которые не могут быть приняты (например, неверный тип сообщения). |
| 1005 | No Status Received        | Индицирует, что никакой код закрытия не был получен. Обычно не используется в сообщениях закрытия. |
| 1006 | Abnormal Closure          | Соединение неожиданно закрылось, например, из-за потери соединения. Не используется в сообщениях закрытия. |
| 1007 | Invalid Frame Payload Data| Получены данные неверного формата во фрейме. |
| 1008 | Policy Violation          | Соединение закрыто из-за нарушения политики. |
| 1009 | Message Too Big           | Соединение закрыто, так как получено слишком большое сообщение. |
| 1010 | Mandatory Extension       | Клиент закрыл соединение, так как сервер не предоставил необходимое расширение. |
| 1011 | Internal Server Error     | Соединение закрыто из-за непредвиденной проблемы на стороне сервера. |
| 1012 | Service Restart           | Сервер закрывает соединение из-за перезапуска. |
| 1013 | Try Again Later           | Сервер закрывает соединение из-за временной перегрузки и предлагает повторить попытку позже. |
| 1014 | Bad Gateway               | Сервер получил неверный ответ от upstream сервера. Обычно не используется в сообщениях закрытия. |
| 1015 | TLS Handshake             | Ошибка TLS рукопожатия. Не передается в сообщениях закрытия. |

## Аутентификация и управление токенами для администратора

### Получение токена администратора

Для получения токена администратора необходимо выполнить запрос на специальный эндпоинт `/login`, используя метод `POST`. В теле запроса должны быть указаны имя пользователя и пароль.

**Запрос:**

```http
POST /admin/login
Content-Type: application/json

{
  "username": "<имя_пользователя>",
  "password": "<пароль>"
}
```

**Успешный ответ:**

```json
{
  "access_token": "<токен_доступа>",
  "token_type": "bearer"
}
```

- `access_token` - токен, который необходимо использовать для аутентификации администратора при выполнении действий через WebSocket.
- `token_type` - тип токена, обычно `bearer`.

**Ответ при ошибке:**

```json
{
  "detail": "Incorrect username or password"
}
```

### Обновление токена доступа

Для обновления токена доступа предусмотрен эндпоинт `/refresh`, на который также нужно отправить `POST` запрос с `refresh_token`.

**Запрос:**

```http
POST /admin/refresh
Content-Type: application/json

{
  "refresh_token": "<токен_для_обновления>"
}
```

**Успешный ответ:**

```json
{
  "access_token": "<новый_токен_доступа>",
  "token_type": "bearer"
}
```

Этот новый `access_token` заменяет старый и используется для дальнейшей аутентификации администратора.

**Ответ при ошибке:**

Ответ при ошибке будет зависеть от причины ошибки, например, неверный `refresh_token` может привести к ответу с описанием ошибки.

---